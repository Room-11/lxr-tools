#!/bin/bash

set -e

ROOM11_LXR_TOOLS_BASE_DIR=$(dirname $0)
ROOM11_LXR_TOOLS_PLATFORM_INSTALLER=$ROOM11_LXR_TOOLS_BASE_DIR/installer/install-$1.sh

if [ ! -f $ROOM11_LXR_TOOLS_PLATFORM_INSTALLER ]; then
  echo "Unknown install target: $1"
  exit 1
fi

#####################
#    C O N F I G    #
#####################

ROOM11_INSTALL_BASE=${ROOM11_INSTALL_BASE:-/opt}
ROOM11_OPENGROK_DATA=${ROOM11_OPENGROK_DATA:-/var/opengrok}
ROOM11_SOURCE_BASE=${ROOM11_SOURCE_BASE:-/srv/sources}

ROOM11_TOMCAT_UID=${ROOM11_TOMCAT_UID:-11011001}
ROOM11_TOMCAT_GID=${ROOM11_TOMCAT_GID:-11011002}

ROOM11_DOCKER_IMAGE=${ROOM11_DOCKER_IMAGE:-room11/opengrok}
ROOM11_DOCKER_KEY_URL=${ROOM11_DOCKER_KEY_URL:-https://yum.dockerproject.org/gpg}

ROOM11_DOCKER_NETWORK_NAME=${ROOM11_DOCKER_NETWORK_NAME:-opengrok}
ROOM11_DOCKER_NETWORK_SUBNET=${ROOM11_DOCKER_NETWORK_SUBNET:-192.168.11.0/24}
ROOM11_DOCKER_NETWORK_GATEWAY=${ROOM11_DOCKER_NETWORK_GATEWAY:-192.168.11.254}
ROOM11_DOCKER_NETWORK_OPENGROK_IP=${ROOM11_DOCKER_NETWORK_OPENGROK_IP:-192.168.11.11}

ROOM11_NGINX_WEB_ROOT=${ROOM11_NGINX_WEB_ROOT:-/srv/www}

if [ -z "$ROOM11_INSTALL_HOST_NAME" ]; then
  ROOM11_INSTALL_HOST_NAME=$(hostname)
fi

if [ -z "$ROOM11_INSTALL_FRONT_END_HOST_NAME" ]; then
  ROOM11_INSTALL_FRONT_END_HOST_NAME=$ROOM11_INSTALL_HOST_NAME
fi

if [ -z "$ROOM11_TOMCAT_BASE" ]; then
  ROOM11_TOMCAT_BASE="$ROOM11_INSTALL_BASE/tomcat"
fi

if [ -z "$ROOM11_OPENGROK_BASE" ]; then
  ROOM11_OPENGROK_BASE="$ROOM11_INSTALL_BASE/opengrok"
fi

if [ -z "$ROOM11_INSTALL_HOST_NAME" ]; then
  ROOM11_INSTALL_HOST_NAME=`hostname`
fi

#####################
#   / C O N F I G   #
#####################

# Perform platform-specific actions
source $ROOM11_LXR_TOOLS_PLATFORM_INSTALLER

# Perform global installation tasks
source $ROOM11_LXR_TOOLS_BASE_DIR/installer/global-install.sh
